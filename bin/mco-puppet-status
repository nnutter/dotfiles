#!/bin/bash

set -o errexit -o pipefail

main() {
    source $(git --exec-path)/git-sh-setup

    BUILD_NUMBER="latest"
    ENVIRONMENT_NAME="production"

    while [ $# -gt 0 ]; do
        OPT="$1"
        shift
        case $OPT in
            --) break ;;
            -b) USE_BUILD=1
                BUILD_NUMBER="$1"
                shift
                unset USE_ENVIRONMENT ENVIRONMENT_NAME
                ;;
            -e) USE_ENVIRONMENT=1
                ENVIRONMENT_NAME="$1"
                shift
                unset USE_BUILD BUILD_NUMBER
                ;;
            -B) USE_BUILD=1
                shift
                unset USE_ENVIRONMENT ENVIRONMENT_NAME
                ;;
            -E) USE_ENVIRONMENT=1
                shift
                unset USE_BUILD BUILD_NUMBER
                ;;
        esac
    done

    if test -n "$USE_BUILD"
    then
        echo -n "Username: "
        read username
        echo -n "Password: "
        read -s password
        RESULT_URL="https://bamboo.gsc.wustl.edu/rest/api/latest/result/PUP3-PSD/${BUILD_NUMBER}.json?os_authType=basic"
        RESULT_TIMESTAMP=$(curl --silent --user "${username}:${password}" "$RESULT_URL" \
            | jq -r .buildCompletedTime)
        PUPPET_TIMESTAMP=$(date -d "$RESULT_TIMESTAMP" +%s)
    else
        PUPPET_TIMESTAMP=$(ssh systems-ci.gsc.wustl.edu stat --format %Z --dereference /export/puppet-modules/puppet/environments/${ENVIRONMENT_NAME})
    fi

    exec mco find --select "resource().config_version < ${PUPPET_TIMESTAMP}"
}

NONGIT_OK=1
OPTIONS_SPEC="\
mco-puppet-status [-E|-B|-e <environment>|-b <build_num>]
--
h,help  show the help
e,environment=   environment, e.g. production
b,build=         build, e.g. 857 or latest
B                --build latest
E                --environment production
"
main "$@"
