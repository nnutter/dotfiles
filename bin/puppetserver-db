#!/usr/bin/env bash

set -o errexit -o nounset -o pipefail

main() {
    local ENDPOINT="$1" QUERY_FILE="$2"
    COMMAND='curl --silent -X GET --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem --cert /etc/puppetlabs/puppet/ssl/certs/puppetserver-puppetboard.gsc.wustl.edu.pem --data @- --key /etc/puppetlabs/puppet/ssl/private_keys/puppetserver-puppetboard.gsc.wustl.edu.pem "https://puppetserver-puppetdb.gsc.wustl.edu:8081/pdb/query/v4/'"${ENDPOINT}"'"'
    echo query="$(cat "$QUERY_FILE" | tr -d '\n' | sed 's/, \+/, /g')" \
        | ssh puppetserver-puppetboard.gsc.wustl.edu "$COMMAND" \
        | jq .
}

main "$@"
